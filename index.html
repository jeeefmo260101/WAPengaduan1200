<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulasi Dashboard Pengaduan BPS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Library untuk QR Code Generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .status-badge {
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
        }
        .status-baru { background-color: #e0f2fe; color: #0ea5e9; }
        .status-menunggu-jawaban-sme { background-color: #fef9c3; color: #eab308; }
        .status-siap-direview { background-color: #dcfce7; color: #22c55e; }
        .status-selesai { background-color: #f3f4f6; color: #6b7280; }
        .status-lewat-sla { background-color: #fee2e2; color: #ef4444; }
        .sidebar-item.active {
            background-color: #1e40af;
            color: #ffffff;
            font-weight: 600;
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .highlight-card {
            border: 2px solid #2563eb;
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.3);
            transform: scale(1.02);
            transition: all 0.3s ease-in-out;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 12px;
            top: 32px;
            bottom: 0;
            width: 2px;
            background-color: #e5e7eb;
            z-index: 0;
        }
        .timeline-item:last-child::before {
            display: none;
        }
        .timeline-dot {
            z-index: 1;
        }
        .rating .star {
            cursor: pointer;
            color: #d1d5db; /* gray-300 */
            transition: color 0.2s;
        }
        .rating .star:hover,
        .rating .star.selected {
            color: #facc15; /* yellow-400 */
        }
        .pulse {
            animation: pulse-animation 2s infinite;
        }
        @keyframes pulse-animation {
            0% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(22, 163, 74, 0); }
            100% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0); }
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="flex flex-col md:flex-row h-screen bg-gray-100">
        <!-- Sidebar -->
        <aside class="w-full md:w-72 bg-gray-800 text-white shadow-lg flex-shrink-0 flex flex-col">
            <div class="p-5 border-b border-gray-700">
                <h1 class="text-xl font-bold">Sistem Pengaduan</h1>
                <p class="text-sm text-gray-400">Badan Pusat Statistik</p>
            </div>
            <nav id="sidebar-nav" class="p-4 space-y-2">
                 <a href="#" data-view="simulation" class="sidebar-item flex items-center gap-3 px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white">
                    <i data-lucide="play-circle" class="w-5 h-5"></i>
                    <span>Mulai Simulasi Baru</span>
                </a>
                <a href="#" data-view="tracking" class="sidebar-item flex items-center gap-3 px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white">
                    <i data-lucide="qr-code" class="w-5 h-5"></i>
                    <span>Lacak Laporan</span>
                </a>
            </nav>
            <div id="timeline-container" class="p-5 space-y-2 mt-4 border-t border-gray-700">
                <!-- Timeline akan dirender di sini -->
            </div>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 p-4 md:p-8 overflow-y-auto">
            <!-- Content will be rendered here by JavaScript -->
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modal-container"></div>


    <script>
        // --- INITIAL STATE & DATA SIMULASI ---
        const defaultComplaintDetail = 'Selamat siang. Saya ingin melaporkan pelayanan di Kantor BPS Kota Medan. Petugas di loket 3 sangat tidak ramah dan tidak mau menjelaskan prosedur dengan baik saat saya bertanya tadi pagi.';
        const initialState = {
            currentView: 'simulation',
            currentStep: -1, // Start before the first step
            ppidInbox: [],
            complaints: [
                { id: 2, no_tiket: 'BPS-PENG-2507-002', status: 'Siap Direview', subjek_pengaduan: 'Dugaan pungli oleh oknum petugas', ditugaskan_ke: 'Tim Investigasi', pelapor: '+62857xxxx5678', detail: 'Ada oknum petugas berinisial A yang meminta "uang rokok" untuk mempercepat proses layanan. Mohon ditindaklanjuti.', jawaban_sme: 'Setelah dilakukan pengecekan awal melalui CCTV dan wawancara saksi, kami menemukan indikasi kuat adanya pelanggaran. Tim akan melakukan pemeriksaan lebih lanjut sesuai prosedur internal. Terlampir adalah notulen investigasi awal.', lampiran_sme: 'notulen_investigasi.pdf' },
                { id: 5, no_tiket: 'BPS-PENG-2507-005', status: 'Selesai', subjek_pengaduan: 'Petugas tidak ramah', ditugaskan_ke: 'Tim Kepegawaian', pelapor: '+62813xxxx7890', detail: 'Petugas di loket 3 sangat tidak ramah dan tidak informatif saat saya bertanya.', jawaban_sme: 'Kami telah melakukan pembinaan terhadap petugas yang bersangkutan dan akan meningkatkan pengawasan serta pelatihan layanan pelanggan. Terima kasih atas laporannya.' },
            ],
            simulationComplaint: {
                id: 7,
                no_tiket: 'BPS-PENG-2507-007',
                status: 'Belum Ada',
                subjek_pengaduan: 'Pelayanan tidak ramah di Kantor BPS Kota Medan',
                ditugaskan_ke: '-',
                pelapor: '+62812xxxx3344',
                detail: defaultComplaintDetail,
                identitas: {}
            }
        };

        let state = JSON.parse(JSON.stringify(initialState));
        let trackingIntervalId = null;

        const timelineSteps = [
            { role: 'pelapor', title: 'Pelapor Mengisi Laporan', icon: 'file-plus-2' },
            { role: 'pelapor', title: 'Pelapor Mengisi Identitas', icon: 'user-plus' },
            { role: 'pelapor', title: 'Menerima Tiket & QR Code', icon: 'smartphone' },
            { role: 'ppid', title: 'PPID Melakukan Klasifikasi', icon: 'inbox' },
            { role: 'admin', title: 'Admin Melakukan Disposisi', icon: 'send' },
            { role: 'sme', title: 'SME Menjawab Aduan', icon: 'user-check' },
            { role: 'admin', title: 'Admin Review & Kirim Jawaban', icon: 'check-circle-2' },
            { role: 'pelapor', title: 'Pelapor Menerima Jawaban', icon: 'mail-check' },
            { role: 'pelapor', title: 'Pelapor Mengisi Survei', icon: 'star' }
        ];

        const mainContent = document.getElementById('main-content');
        const modalContainer = document.getElementById('modal-container');
        const timelineContainer = document.getElementById('timeline-container');
        const sidebarNav = document.getElementById('sidebar-nav');
        
        // --- RENDER FUNCTIONS ---
        function renderTimeline(steps = timelineSteps, currentStepIndex = state.currentStep) {
            if (currentStepIndex < 0) {
                 timelineContainer.innerHTML = `<p class="text-sm text-gray-400">Timeline akan muncul saat simulasi berjalan.</p>`;
                 return;
            }
            timelineContainer.innerHTML = steps.map((step, index) => `
                <div class="timeline-item relative pl-10 pb-6">
                    <div class="timeline-dot absolute left-0 top-1 w-6 h-6 rounded-full flex items-center justify-center ${currentStepIndex >= index ? 'bg-blue-600 text-white' : 'bg-gray-600 text-gray-400'}">
                        <i data-lucide="${currentStepIndex > index ? 'check' : step.icon}" class="w-4 h-4"></i>
                    </div>
                    <p class="font-semibold ${currentStepIndex === index ? 'text-white' : 'text-gray-400'}">${step.title}</p>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderLoginView() {
            mainContent.innerHTML = `
                <div class="flex items-center justify-center h-full">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 text-center w-full max-w-md">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="shield-check" class="w-8 h-8 text-blue-600"></i>
                        </div>
                        <h2 class="text-2xl font-bold mb-2">Simulasi Sistem Pengaduan</h2>
                        <p class="text-gray-500 mb-6">Pilih fitur yang ingin Anda simulasikan dari menu di sebelah kiri.</p>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function renderInitialView() {
            mainContent.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center bg-white rounded-2xl shadow-lg p-8 ${state.currentStep === 0 ? 'highlight-card' : ''}">
                    <div class="w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center mb-6">
                        <i data-lucide="file-plus-2" class="w-12 h-12 text-blue-600"></i>
                    </div>
                    <h2 class="text-3xl font-bold mb-2">Langkah 1: Tulis Laporan Anda</h2>
                    <p class="max-w-xl text-gray-600 mb-6">Anda bisa menggunakan contoh yang ada atau mengetik laporan Anda sendiri.</p>
                    
                    <div class="w-full max-w-lg mb-6">
                        <label for="custom-report-input" class="block text-sm font-medium text-gray-700 mb-2 text-left">Isi Laporan Anda:</label>
                        <textarea id="custom-report-input" class="w-full p-3 border border-gray-300 rounded-lg h-28 text-sm" placeholder="${defaultComplaintDetail}"></textarea>
                    </div>

                    <button id="start-simulation-btn" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 font-bold text-lg flex items-center gap-3 transition-transform transform hover:scale-105">
                        <i data-lucide="arrow-right" class="w-5 h-5"></i>
                        <span>Lanjutkan ke Pengisian Identitas</span>
                    </button>
                </div>
            `;
            document.getElementById('start-simulation-btn').addEventListener('click', startSimulation);
            lucide.createIcons();
        }

        function renderIdentityFormView() {
            mainContent.innerHTML = `
                <div class="max-w-lg mx-auto bg-white rounded-xl shadow-lg p-8 ${state.currentStep === 1 ? 'highlight-card' : ''}">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mb-4 mx-auto">
                            <i data-lucide="user-plus" class="w-8 h-8 text-blue-600"></i>
                        </div>
                        <h2 class="text-2xl font-bold">Langkah 2: Lengkapi Identitas</h2>
                        <p class="text-gray-500 mt-1">Identitas yang jelas membantu kami menindaklanjuti laporan Anda.</p>
                    </div>
                    
                    <div class="mt-8 space-y-4">
                        <div>
                            <label for="identity-name" class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                            <input type="text" id="identity-name" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="identity-address" class="block text-sm font-medium text-gray-700">Alamat</label>
                            <input type="text" id="identity-address" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="identity-phone" class="block text-sm font-medium text-gray-700">No. Telepon</label>
                            <input type="tel" id="identity-phone" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="identity-email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="identity-email" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div class="flex items-start pt-2">
                            <div class="flex items-center h-5">
                                <input id="anonymous-checkbox" type="checkbox" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded">
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="anonymous-checkbox" class="font-medium text-gray-700">Saya ingin melapor secara anonim (tanpa nama)</label>
                                <p id="anonymous-warning" class="text-gray-500 hidden mt-1">Laporan dengan identitas yang jelas akan lebih mudah ditindaklanjuti.</p>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-8">
                        <button id="submit-identity-btn" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 font-bold">Lanjutkan & Dapatkan Tiket</button>
                    </div>
                </div>
            `;
            lucide.createIcons();
            setupIdentityFormInteractions();
        }

        function renderPelaporView(isFinal = false) {
             mainContent.innerHTML = `
                <div class="max-w-lg mx-auto bg-white rounded-xl shadow-lg p-6 ${state.currentStep === 2 ? 'highlight-card' : ''}">
                    <h2 class="text-2xl font-bold text-center mb-1">Langkah 3: Tanda Terima & Pelacakan</h2>
                    <p class="text-center text-gray-500 mb-4">Laporan Anda berhasil dikirim!</p>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="w-full max-w-sm mx-auto bg-white border border-gray-200 rounded-lg shadow-sm p-4">
                            <div class="bg-blue-100 text-blue-800 p-3 rounded-lg ml-auto max-w-xs text-sm mb-4">
                                ${state.simulationComplaint.detail}
                            </div>
                            <div class="bg-gray-100 text-gray-800 p-3 rounded-lg mr-auto max-w-xs text-sm">
                                <p class="mb-2">Terima kasih telah menghubungi BPS. Laporan Anda telah kami terima.</p>
                                <p class="mb-2">Nomor Tiket Anda:<br><strong class="font-bold">${state.simulationComplaint.no_tiket}</strong></p>
                                <!-- Canvas untuk QR Code -->
                                <canvas id="qrcode-canvas" class="rounded-md mx-auto mt-2"></canvas>
                            </div>
                            ${isFinal ? `
                            <div class="bg-gray-100 text-gray-800 p-3 rounded-lg mr-auto max-w-xs text-sm mt-4">
                                <p class="font-bold mb-2">Jawaban Final:</p>
                                <p>Terima kasih atas laporan Anda. Kami telah melakukan pembinaan kepada petugas yang bersangkutan dan akan meningkatkan kualitas layanan kami.</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ${state.currentStep === 2 ? `
                    <div class="text-center mt-6">
                        <p class="text-gray-600 mb-4">Sistem mengirimkan balasan otomatis ke WhatsApp pelapor. Alur selanjutnya akan berjalan di sistem internal BPS.</p>
                        <button id="continue-internal-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-bold">Lanjutkan ke Proses Internal</button>
                    </div>` : ''}
                    ${isFinal ? `
                    <div class="text-center mt-6">
                         <p class="text-gray-600 mb-4">Pelapor telah menerima jawaban final. Sistem secara otomatis akan mengirimkan tautan survei.</p>
                        <button id="show-survey-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 font-bold">Lanjutkan ke Survei</button>
                    </div>
                    ` : ''}
                </div>
            `;
            const canvas = document.getElementById('qrcode-canvas');
            if (canvas) {
                const urlToEncode = `https://bps.go.id/lacak?tiket=${state.simulationComplaint.no_tiket}`;
                QRCode.toCanvas(canvas, urlToEncode, { width: 180, margin: 2 }, function (error) {
                    if (error) console.error(error);
                });
            }
            if (state.currentStep === 2) {
                document.getElementById('continue-internal-btn').addEventListener('click', () => {
                    state.currentStep = 3;
                    state.ppidInbox.push({
                        id: 99,
                        pengirim: state.simulationComplaint.pelapor,
                        cuplikan: state.simulationComplaint.detail,
                        jenis: 'pengaduan'
                    });
                    updateView();
                });
            }
            if (isFinal) {
                 document.getElementById('show-survey-btn').addEventListener('click', () => {
                    state.currentStep = 8;
                    updateView();
                });
            }
        }
        
        function renderPpidDashboard() {
            mainContent.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg ${state.currentStep === 3 ? 'highlight-card' : ''}">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h2 class="text-2xl font-bold">Dashboard Verifikator - PPID</h2>
                        <div class="bg-blue-100 text-blue-800 font-bold py-2 px-4 rounded-full">
                            ${state.ppidInbox.length} Pesan Baru
                        </div>
                    </div>
                    <div class="space-y-4">
                        ${state.ppidInbox.map((msg, index) => `
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center bg-gray-50 p-4 rounded-lg">
                                <div class="font-medium">${msg.pengirim}</div>
                                <div class="text-gray-600 text-sm">${msg.cuplikan}</div>
                                <div class="flex justify-start md:justify-center gap-2">
                                    <button onclick="handlePpidAction(${index})" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 text-sm font-semibold flex items-center gap-2">
                                        <i data-lucide="arrow-right-circle" class="w-4 h-4"></i>
                                        <span>Jadikan Pengaduan</span>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ${state.currentStep === 3 ? `
                    <div class="text-center mt-6 bg-blue-50 p-4 rounded-lg">
                        <p class="text-gray-600 mb-4">Laporan dari pelapor masuk ke inbox PPID. Petugas PPID harus mengklasifikasikannya.</p>
                        <p class="font-semibold">Klik tombol "Jadikan Pengaduan" untuk melanjutkan.</p>
                    </div>` : ''}
                </div>
            `;
            lucide.createIcons();
        }

        function renderAdminDashboard(isFinalReview = false) {
            const dataToShow = isFinalReview ? state.complaints.filter(c => c.id === state.simulationComplaint.id) : state.complaints;
            mainContent.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg ${state.currentStep === 4 || state.currentStep === 6 ? 'highlight-card' : ''}">
                    <h2 class="text-2xl font-bold mb-6">Dashboard Manajemen Pengaduan</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                                <tr><th class="p-3">No. Tiket</th><th class="p-3">Status</th><th class="p-3">Subjek Pengaduan</th><th class="p-3">Ditugaskan ke</th><th class="p-3 text-center">Aksi</th></tr>
                            </thead>
                            <tbody>
                                ${dataToShow.map(item => `
                                    <tr class="border-b hover:bg-gray-50 ${item.id === state.simulationComplaint.id ? 'bg-blue-50' : ''}">
                                        <td class="p-3 font-medium">${item.no_tiket}</td>
                                        <td class="p-3"><span class="status-badge status-${item.status.toLowerCase().replace(/ /g, '-')}">${item.status}</span></td>
                                        <td class="p-3">${item.subjek_pengaduan}</td>
                                        <td class="p-3">${item.ditugaskan_ke}</td>
                                        <td class="p-3 text-center">
                                            ${renderAdminActionButtons(item)}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                     ${state.currentStep === 4 ? `
                    <div class="text-center mt-6 bg-blue-50 p-4 rounded-lg">
                        <p class="text-gray-600 mb-4">Pengaduan baru muncul di dashboard Admin. Admin harus mendisposisikannya ke tim yang tepat.</p>
                        <p class="font-semibold">Klik tombol "Disposisi" pada laporan baru untuk melanjutkan.</p>
                    </div>` : ''}
                     ${state.currentStep === 6 ? `
                    <div class="text-center mt-6 bg-blue-50 p-4 rounded-lg">
                        <p class="text-gray-600 mb-4">Jawaban dari SME telah masuk. Admin harus mereview dan mengirimkan jawaban final ke pelapor.</p>
                        <p class="font-semibold">Klik tombol "Review & Jawab" untuk melanjutkan.</p>
                    </div>` : ''}
                </div>
            `;
            lucide.createIcons();
        }
        
        function renderSmeDashboard() {
            const smeTasks = state.complaints.filter(c => c.status === 'Menunggu Jawaban SME' && c.id === state.simulationComplaint.id);
            mainContent.innerHTML = `
                 <div class="bg-white p-6 rounded-xl shadow-lg ${state.currentStep === 5 ? 'highlight-card' : ''}">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h2 class="text-2xl font-bold">Dashboard Tugas - SME</h2>
                    </div>
                    <div class="space-y-4">
                        ${smeTasks.length > 0 ? smeTasks.map(task => `
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center bg-gray-50 p-4 rounded-lg">
                                <div class="font-medium">${task.no_tiket}</div>
                                <div class="text-gray-600 text-sm">${task.subjek_pengaduan}</div>
                                <div class="text-center">
                                    <button onclick="openSmeModal(${task.id})" class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 text-sm font-semibold flex items-center gap-2 mx-auto">
                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                        <span>Jawab Sekarang</span>
                                    </button>
                                </div>
                            </div>
                        `).join('') : '<p class="text-center text-gray-500 py-8">Tidak ada tugas saat ini.</p>'}
                    </div>
                    ${state.currentStep === 5 ? `
                    <div class="text-center mt-6 bg-blue-50 p-4 rounded-lg">
                        <p class="text-gray-600 mb-4">Tim Kepegawaian (SME) menerima tugas. Mereka harus melakukan investigasi dan memberikan jawaban.</p>
                        <p class="font-semibold">Klik "Jawab Sekarang" untuk membuka form jawaban.</p>
                    </div>` : ''}
                </div>
            `;
            lucide.createIcons();
        }

        function renderSurveyView() {
             mainContent.innerHTML = `
                <div class="max-w-lg mx-auto bg-white rounded-xl shadow-lg p-8 ${state.currentStep === 8 ? 'highlight-card' : ''}">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-4 mx-auto">
                            <i data-lucide="award" class="w-8 h-8 text-green-600"></i>
                        </div>
                        <h2 class="text-2xl font-bold">Survei Kepuasan Layanan</h2>
                        <p class="text-gray-500 mt-1">Tiket: ${state.simulationComplaint.no_tiket}</p>
                    </div>
                    
                    <div class="mt-8 space-y-6">
                        <div><label class="font-semibold block mb-2 text-sm">1. Kecepatan Penanganan</label><div class="star-rating flex justify-center gap-2 text-gray-300" data-rating="0"><i data-lucide="star" class="star" data-value="1"></i><i data-lucide="star" class="star" data-value="2"></i><i data-lucide="star" class="star" data-value="3"></i><i data-lucide="star" class="star" data-value="4"></i><i data-lucide="star" class="star" data-value="5"></i></div></div>
                        <div><label class="font-semibold block mb-2 text-sm">2. Kejelasan Jawaban yang Diberikan</label><div class="star-rating flex justify-center gap-2 text-gray-300" data-rating="0"><i data-lucide="star" class="star" data-value="1"></i><i data-lucide="star" class="star" data-value="2"></i><i data-lucide="star" class="star" data-value="3"></i><i data-lucide="star" class="star" data-value="4"></i><i data-lucide="star" class="star" data-value="5"></i></div></div>
                        <div><label class="font-semibold block mb-2 text-sm">3. Kesesuaian Jawaban dengan Laporan</label><div class="star-rating flex justify-center gap-2 text-gray-300" data-rating="0"><i data-lucide="star" class="star" data-value="1"></i><i data-lucide="star" class="star" data-value="2"></i><i data-lucide="star" class="star" data-value="3"></i><i data-lucide="star" class="star" data-value="4"></i><i data-lucide="star" class="star" data-value="5"></i></div></div>
                        <div><label class="font-semibold block mb-2 text-sm">4. Bahasa dan Komunikasi yang Digunakan</label><div class="star-rating flex justify-center gap-2 text-gray-300" data-rating="0"><i data-lucide="star" class="star" data-value="1"></i><i data-lucide="star" class="star" data-value="2"></i><i data-lucide="star" class="star" data-value="3"></i><i data-lucide="star" class="star" data-value="4"></i><i data-lucide="star" class="star" data-value="5"></i></div></div>
                        <div><label for="survey-comment" class="font-semibold block mb-2 text-sm">5. Saran atau Masukan Lainnya</label><textarea id="survey-comment" class="w-full p-2 border border-gray-300 rounded-md h-24" placeholder="Tulis masukan Anda di sini..."></textarea></div>
                    </div>

                    <div class="text-center mt-8">
                        <button id="submit-survey-btn" class="w-full bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 font-bold">Kirim Survei</button>
                    </div>
                </div>
            `;
            lucide.createIcons();
            setupSurveyInteractions();
        }

        function renderTrackingView() {
            mainContent.innerHTML = `
                <div class="max-w-lg mx-auto bg-white rounded-xl shadow-lg p-8">
                     <div class="text-center">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mb-4 mx-auto">
                            <i data-lucide="search" class="w-8 h-8 text-blue-600"></i>
                        </div>
                        <h2 class="text-2xl font-bold">Lacak Laporan Anda</h2>
                        <p class="text-gray-500 mt-1">Masukkan nomor tiket untuk melihat progres.</p>
                    </div>
                    <div id="tracking-input-container" class="mt-8">
                        <input type="text" id="ticket-input" class="w-full p-3 text-center text-lg font-semibold border-2 border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: BPS-PENG-2507-007">
                        <button id="track-ticket-btn" class="mt-4 w-full bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 font-bold">Lacak Tiket</button>
                    </div>
                    <div id="tracking-result-container" class="hidden mt-8">
                         <h3 class="font-semibold mb-4">Riwayat Progres:</h3>
                         <div id="tracking-timeline" class="space-y-1"></div>
                         <div id="tracking-survey-button" class="hidden mt-8 text-center bg-green-50 p-4 rounded-lg border border-green-200">
                            <h3 class="font-bold text-green-800 mb-2">Laporan Anda Telah Selesai!</h3>
                            <p class="text-sm text-green-700 mb-4">Terima kasih atas masukan Anda. Mohon bantu kami menjadi lebih baik dengan mengisi survei singkat.</p>
                            <button onclick="switchView('survey')" class="w-full bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 font-semibold flex items-center justify-center gap-2 pulse">
                                <i data-lucide="star" class="w-5 h-5"></i>
                                <span>Klik di Sini untuk Mengisi Survei</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('track-ticket-btn').addEventListener('click', handleTrackTicket);
            lucide.createIcons();
        }

        function renderAdminActionButtons(item) {
            if (item.id !== state.simulationComplaint.id) return `<span class="text-gray-400 text-sm">N/A</span>`;
            switch (item.status) {
                case 'Baru':
                    return `<button onclick="openDisposisiModal(${item.id})" class="bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 text-sm font-semibold">Disposisi</button>`;
                case 'Siap Direview':
                    return `<button onclick="openReviewModal(${item.id})" class="bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600 text-sm font-semibold">Review & Jawab</button>`;
                default:
                    return `<span class="text-gray-400 text-sm">Menunggu</span>`;
            }
        }

        // --- MODAL & ACTION HANDLERS ---
        window.openDisposisiModal = (id) => {
            const complaint = state.complaints.find(c => c.id === id);
            modalContainer.innerHTML = `
                <div class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                    <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
                        <h3 class="text-xl font-bold mb-4">Disposisi Tiket: ${complaint.no_tiket}</h3>
                        <p class="mb-4 bg-gray-50 p-3 rounded-md text-sm">"${complaint.detail}"</p>
                        <label for="sme-select" class="block text-sm font-medium text-gray-700 mb-2">Tugaskan ke:</label>
                        <select id="sme-select" class="w-full p-2 border border-gray-300 rounded-md"><option>Tim Kepegawaian</option></select>
                        <div class="flex justify-end gap-4 mt-6">
                            <button onclick="handleDisposisi(${id})" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-semibold">Kirim Disposisi</button>
                        </div>
                    </div>
                </div>`;
        }
        
        window.openReviewModal = (id) => {
             const complaint = state.complaints.find(c => c.id === id);
             modalContainer.innerHTML = `
                <div class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                    <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6">
                        <h3 class="text-xl font-bold mb-4">Review & Kirim Jawaban</h3>
                        <div class="space-y-4">
                            <div><h4 class="font-semibold">Pengaduan Asli:</h4><p class="bg-gray-50 p-3 rounded-md text-sm mt-1">"${complaint.detail}"</p></div>
                            <div><h4 class="font-semibold">Jawaban dari SME (${complaint.ditugaskan_ke}):</h4><p class="bg-blue-50 p-3 rounded-md text-sm mt-1">"${complaint.jawaban_sme}"</p></div>
                            <div><h4 class="font-semibold">Jawaban Final untuk Pelapor:</h4><textarea id="final-answer" class="w-full p-2 border border-gray-300 rounded-md mt-1 h-24 text-sm">Terima kasih atas laporan Anda. Kami telah melakukan pembinaan kepada petugas yang bersangkutan dan akan meningkatkan kualitas layanan kami.</textarea></div>
                        </div>
                        <div class="flex justify-end gap-4 mt-6">
                            <button onclick="handleSendAnswer(${id})" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 font-semibold">Kirim Jawaban Akhir</button>
                        </div>
                    </div>
                </div>`;
        }

        window.openSmeModal = (id) => {
            const complaint = state.complaints.find(c => c.id === id);
            modalContainer.innerHTML = `
                <div class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                    <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-xl p-6">
                        <h3 class="text-xl font-bold mb-4">Jawab Pengaduan: ${complaint.no_tiket}</h3>
                        <div><h4 class="font-semibold">Detail Pengaduan:</h4><p class="bg-gray-50 p-3 rounded-md text-sm mt-1">"${complaint.detail}"</p></div>
                        <div class="mt-4"><label for="sme-answer" class="block text-sm font-medium mb-2">Jawaban Anda:</label><textarea id="sme-answer" class="w-full p-2 border rounded-md mt-1 h-24 text-sm">Telah dilakukan konfirmasi dan pembinaan langsung kepada petugas yang bersangkutan. Kami memohon maaf atas ketidaknyamanan yang terjadi. Sebagai tindak lanjut, kami akan mengadakan sesi penyegaran kembali mengenai standar pelayanan pelanggan untuk seluruh staf frontliner minggu depan.</textarea></div>
                        <div class="flex justify-end gap-4 mt-6">
                            <button onclick="handleSmeSubmit(${id})" class="bg-yellow-500 text-white px-6 py-2 rounded-lg hover:bg-yellow-600 font-semibold">Submit Jawaban ke Admin</button>
                        </div>
                    </div>
                </div>`;
        }

        window.handlePpidAction = (index) => {
            state.ppidInbox.splice(index, 1);
            const newComplaint = { ...state.simulationComplaint, status: 'Baru' };
            state.complaints.unshift(newComplaint);
            state.currentStep = 4;
            updateView();
        }

        window.handleDisposisi = (id) => {
            const complaint = state.complaints.find(c => c.id === id);
            complaint.status = 'Menunggu Jawaban SME';
            complaint.ditugaskan_ke = 'Tim Kepegawaian';
            modalContainer.innerHTML = '';
            state.currentStep = 5;
            updateView();
        }
        
        window.handleSmeSubmit = (id) => {
            const complaint = state.complaints.find(c => c.id === id);
            complaint.status = 'Siap Direview';
            complaint.jawaban_sme = document.getElementById('sme-answer').value;
            modalContainer.innerHTML = '';
            state.currentStep = 6;
            updateView();
        }

        window.handleSendAnswer = (id) => {
            const complaint = state.complaints.find(c => c.id === id);
            complaint.status = 'Selesai';
            modalContainer.innerHTML = '';
            state.currentStep = 7;
            updateView();
        }

        // --- SURVEY & MAIN APP LOGIC ---
        function setupSurveyInteractions() {
            document.querySelectorAll('.star-rating').forEach(ratingGroup => {
                const stars = ratingGroup.querySelectorAll('svg');
                ratingGroup.addEventListener('click', e => {
                    const star = e.target.closest('svg');
                    if (!star) return;
                    
                    const ratingValue = star.dataset.value;
                    ratingGroup.dataset.rating = ratingValue;

                    stars.forEach(s => {
                        s.classList.remove('selected', 'text-yellow-400');
                        s.removeAttribute('fill');
                        if(s.dataset.value <= ratingValue) {
                            s.classList.add('selected', 'text-yellow-400');
                            s.setAttribute('fill', 'currentColor');
                        }
                    });
                });
            });
            
            document.getElementById('submit-survey-btn').addEventListener('click', () => {
                alert('Terima kasih! Survei Anda telah berhasil dikirim. Masukan Anda sangat berharga bagi kami.');
                resetSimulation();
            });
        }
        
        function setupIdentityFormInteractions() {
            const checkbox = document.getElementById('anonymous-checkbox');
            const warning = document.getElementById('anonymous-warning');
            const inputs = ['identity-name', 'identity-address', 'identity-phone', 'identity-email'].map(id => document.getElementById(id));

            checkbox.addEventListener('change', () => {
                const isChecked = checkbox.checked;
                warning.classList.toggle('hidden', !isChecked);
                inputs.forEach(input => {
                    input.disabled = isChecked;
                    input.required = !isChecked;
                    if (isChecked) {
                        input.value = 'Anonim';
                        input.classList.add('bg-gray-100');
                    } else {
                        input.value = '';
                        input.classList.remove('bg-gray-100');
                    }
                });
            });

            document.getElementById('submit-identity-btn').addEventListener('click', () => {
                if (!checkbox.checked && inputs.some(input => input.value.trim() === '')) {
                    alert('Harap isi semua kolom identitas atau pilih opsi anonim.');
                    return;
                }
                // Store identity data
                state.simulationComplaint.identitas.nama = document.getElementById('identity-name').value;
                state.simulationComplaint.identitas.alamat = document.getElementById('identity-address').value;
                // etc.

                state.currentStep = 2; // Move to the next step (WhatsApp view)
                updateView();
            });
        }


        function updateView() {
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            const activeItem = document.querySelector(`.sidebar-item[data-view="${state.currentView}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
            
            if (state.currentView === 'simulation') {
                renderTimeline();
                const currentStepData = timelineSteps[state.currentStep];
                if (!currentStepData) {
                    renderInitialView();
                    return;
                }
                switch (state.currentStep) {
                    case 0: renderInitialView(); break;
                    case 1: renderIdentityFormView(); break;
                    case 2: renderPelaporView(false); break;
                    case 3: renderPpidDashboard(); break;
                    case 4: renderAdminDashboard(false); break;
                    case 5: renderSmeDashboard(); break;
                    case 6: renderAdminDashboard(true); break;
                    case 7: renderPelaporView(true); break;
                    case 8: renderSurveyView(); break;
                }
            } else if (state.currentView === 'tracking') {
                timelineContainer.innerHTML = `<p class="text-sm text-gray-400">Mode Pelacakan Aktif.</p>`;
                renderTrackingView();
            } else {
                renderLoginView();
            }
        }
        
        function handleTrackTicket() {
            const ticketInput = document.getElementById('ticket-input').value;
            if (!ticketInput.trim()) {
                alert('Silakan masukkan nomor tiket.');
                return;
            }
            document.getElementById('tracking-input-container').classList.add('hidden');
            document.getElementById('tracking-result-container').classList.remove('hidden');

            const trackingTimelineEl = document.getElementById('tracking-timeline');
            const trackingSurveyBtn = document.getElementById('tracking-survey-button');
            let trackingStep = 0;
            
            clearInterval(trackingIntervalId);
            trackingIntervalId = setInterval(() => {
                trackingTimelineEl.innerHTML = '';
                for (let i = 0; i <= trackingStep; i++) {
                    const item = timelineSteps[i+2]; // Start from "Menerima Tiket"
                    if (!item) continue;
                    const isCompleted = i < trackingStep;
                    const isActive = i === trackingStep;

                    const timelineItem = document.createElement('div');
                    timelineItem.className = "timeline-item relative pl-12 pb-6";
                    
                    let dotClass = 'bg-gray-300 text-gray-500';
                    if (isCompleted) dotClass = 'bg-green-500 text-white';
                    if (isActive) dotClass = 'bg-blue-500 text-white';

                    timelineItem.innerHTML = `<div class="timeline-dot absolute left-0 top-1 w-8 h-8 rounded-full flex items-center justify-center ${dotClass}"><i data-lucide="${isCompleted ? 'check' : item.icon}" class="w-5 h-5"></i></div><div><p class="font-semibold ${isActive ? 'text-blue-600' : ''}">${item.title}</p></div>`;
                    trackingTimelineEl.appendChild(timelineItem);
                }
                lucide.createIcons();

                if (trackingStep < timelineSteps.length - 3) {
                    trackingStep++;
                } else {
                    trackingSurveyBtn.classList.remove('hidden');
                    clearInterval(trackingIntervalId);
                }
            }, 1500);
        }

        function switchView(viewName) {
            state.currentView = viewName;
            state.currentStep = -1; // Reset step when switching view
            clearInterval(trackingIntervalId);
            updateView();
        }

        function startSimulation() {
            const customReport = document.getElementById('custom-report-input').value;
            if (customReport.trim() !== '') {
                state.simulationComplaint.detail = customReport;
                state.simulationComplaint.subjek_pengaduan = customReport.substring(0, 50) + '...';
            } else {
                state.simulationComplaint.detail = defaultComplaintDetail;
                state.simulationComplaint.subjek_pengaduan = 'Pelayanan tidak ramah di Kantor BPS Kota Medan';
            }

            state.currentStep = 1;
            updateView();
        }
        
        function resetSimulation() {
            state = JSON.parse(JSON.stringify(initialState));
            switchView('simulation');
        }

        sidebarNav.addEventListener('click', (e) => {
            e.preventDefault();
            const targetLink = e.target.closest('.sidebar-item');
            if (targetLink) {
                const view = targetLink.dataset.view;
                switchView(view);
            }
        });
        
        // Initial Render
        lucide.createIcons();
        switchView('simulation');

    </script>
</body>
</html>

